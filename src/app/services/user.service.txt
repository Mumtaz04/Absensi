import { Injectable } from '@angular/core';
import { HttpClient, HttpHeaders } from '@angular/common/http';
import { environment } from 'src/environments/environment';
import { BehaviorSubject } from 'rxjs';

export interface AppUser {
  id?: number;
  name?: string;
  email?: string;
  position?: string;
  photo?: string;
  photo_url?: string;
  [key: string]: any;
}

const STORAGE_KEY = 'app_user_v1';

@Injectable({
  providedIn: 'root',
})
export class UserService {
  /**
   * environment.apiUrl seharusnya berisi base host
   */
  private baseUrl = environment.apiUrl || '';

  private userSubject = new BehaviorSubject<AppUser | null>(this.loadFromStorage());
  public user$ = this.userSubject.asObservable();

  constructor(private http: HttpClient) {}

  // ---------------- Helpers ----------------
  private buildUrl(path: string) {
    const trimmedBase = this.baseUrl.replace(/\/+$/, '');
    let trimmedPath = (path || '').replace(/^\/+/, '');

    if (/\/api$/i.test(trimmedBase) && /^api\//i.test(trimmedPath)) {
      trimmedPath = trimmedPath.replace(/^api\//i, '');
    }

    return `${trimmedBase}/${trimmedPath}`;
  }

  private authHeaders(): { headers: HttpHeaders } {
    const token = localStorage.getItem('token') ?? '';
    const headers = new HttpHeaders({
      Authorization: token ? `Bearer ${token}` : '',
      Accept: 'application/json',
      'X-Requested-With': 'XMLHttpRequest'
    });
    return { headers };
  }

  // ---------------- API methods ----------------
  checkIn(data: any) {
    return this.http.post(this.buildUrl('api/employee/check-in'), data, this.authHeaders());
  }

  checkOut(data: any) {
    return this.http.post(this.buildUrl('api/employee/check-out'), data, this.authHeaders());
  }

  updateProfilePhoto(formData: FormData) {
    return this.http.post<any>(this.buildUrl('api/user/photo'), formData, this.authHeaders());
  }

  // ---------------- Shared state helpers ----------------
  setUser(user: AppUser | null) {
    this.userSubject.next(user);
    this.saveToStorage(user);
  }

  setPhoto(photoPathOrUrl: string | null) {
    const current = { ...(this.userSubject.value ?? {}) } as AppUser;

    const normalize = (p: string) => {
      if (!p) return null;
      const s = p.toString().trim();
      if (!s) return null;
      if (/^(data:|blob:)/.test(s)) return s;
      if (/^https?:\/\//i.test(s)) {
        return s.replace(/\/api\/storage\//i, '/storage/');
      }
      let clean = s.replace(/^\/+/, '');
      if (/^photos\//i.test(clean)) {
        clean = clean.replace(/^photos\//i, 'storage/photos/');
      }
      clean = clean.replace(/^api\/storage\//i, 'storage/');
      const base = this.baseUrl.replace(/\/+$/, '');
      return `${base}/${clean}`;
    };

    try {
      if (photoPathOrUrl) {
        const normalized = normalize(photoPathOrUrl);
        if (normalized) {
          current.photo = normalized;
          current.photo_url = normalized;
          if (/^data:/.test(normalized)) {
            localStorage.setItem('profileImageBase64', normalized);
            localStorage.removeItem('profileImageUrl');
          } else {
            localStorage.setItem('profileImageUrl', normalized);
            localStorage.removeItem('profileImageBase64');
          }
        } else {
          current.photo = photoPathOrUrl;
          current.photo_url = photoPathOrUrl;
        }
      } else {
        delete current.photo;
        delete current.photo_url;
        try { localStorage.removeItem('profileImageUrl'); localStorage.removeItem('profileImageBase64'); } catch(e) {}
      }
    } catch (e) {
      if (photoPathOrUrl) {
        current.photo = photoPathOrUrl;
        current.photo_url = photoPathOrUrl;
      } else {
        delete current.photo;
        delete current.photo_url;
      }
    }

    this.userSubject.next(current);
    this.saveToStorage(current);
  }

  getCurrentUser(): AppUser | null {
    return this.userSubject.value;
  }

  clear() {
    this.userSubject.next(null);
    try {
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem('profileImageUrl');
      localStorage.removeItem('profileImageBase64');
    } catch (e) {}
  }

  // ---------------- persistence ----------------
  private saveToStorage(user: AppUser | null) {
    try {
      if (user) localStorage.setItem(STORAGE_KEY, JSON.stringify(user));
      else localStorage.removeItem(STORAGE_KEY);
    } catch (e) {
      console.warn('UserService.saveToStorage error', e);
    }
  }

  private loadFromStorage(): AppUser | null {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : null;
    } catch (e) {
      console.warn('UserService.loadFromStorage error', e);
      return null;
    }
  }
}
